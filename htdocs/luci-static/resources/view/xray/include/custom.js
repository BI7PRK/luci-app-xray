/**
 * @license
 * Copyright 2020 Xingwang Liao <kuoruan@gmail.com>
 *
 * Licensed to the public under the MIT License.
 */
"use strict";"require form";"require fs";"require rpc";"require uci";"require ui";var callRunningStatus=rpc.declare({object:"luci.xray",method:"runningStatus",params:[],expect:{"":{code:1}}}),callListStatus=rpc.declare({object:"luci.xray",method:"listStatus",params:["name"],expect:{"":{code:1}},filter:function(t){return 0===t.code?{count:t.count,datetime:t.datetime}:{count:0,datetime:_("Unknown")}}}),callxrayVersion=rpc.declare({object:"luci.xray",method:"xrayVersion",params:[],expect:{"":{code:1}},filter:function(t){return t.code?"":t.version}}),callGetUuid=rpc.declare({object:"luci.xray",method:"xrayUuid",params:["name"],expect:{"":{code:1}},filter:function(t){return t.code?"":t.uuid}}),callX25519=rpc.declare({object:"luci.xray",method:"xrayX25519",params:["i"],expect:{"":{code:1}},filter:function(t){return 0===t.code?t:{publicKey:"",privateKey:""}}}),mldsa65Func=rpc.declare({object:"luci.xray",method:"xrayMldsa65",expect:{"":{code:1}},filter:function(t){return 0===t.code?t:{seed:"",verify:""}}}),CUSTOMTextValue=form.TextValue.extend({__name__:"CUSTOM.TextValue",filepath:null,isjson:!1,required:!1,cfgvalue:function(){return this.filepath?L.resolveDefault(fs.read(this.filepath),""):this.super("cfgvalue",L.toArray(arguments))},write:function(t,e){if(!this.filepath)return this.super("write",L.toArray(arguments));var i=e.trim().replace(/\r\n/g,"\n")+"\n";return fs.write(this.filepath,i)},validate:function(t,e){if(this.required&&!e){var i=this.titleFn("title",t);return _("%s is required.").format(i)}if(this.isjson){var n=void 0;try{n=JSON.parse(e)}catch(t){n=null}if(!n||"object"!=typeof n)return _("Invalid JSON content.")}return!0}}),CUSTOMListStatusValue=form.AbstractValue.extend({__name__:"CUSTOM.ListStatusValue",listtype:null,onupdate:null,btnstyle:"button",btntitle:null,cfgvalue:function(){return this.listtype||L.error("TypeError",_("Listtype is required")),L.resolveDefault(callListStatus(this.listtype),{count:0,datetime:_("Unknown")})},render:function(t,e){return Promise.resolve(this.cfgvalue(e)).then(L.bind((function(i){var n=void 0===i?{}:i,r=n.count,a=void 0===r?0:r,s=n.datetime,l=void 0===s?"":s,c=this.titleFn("title",e),o=this.uciconfig||this.section.uciconfig||this.map.config,u=this.transformDepList(e),d=[E("div",{},[E("span",{style:"color: #ff8c00;margin-right: 5px;"},_("Total: %s").format(a)),_("Time: %s").format(l),E("button",{style:"margin-left: 10px;",class:"cbi-button cbi-button-%s".format(this.btnstyle||"button"),click:ui.createHandlerFn(this,(function(t,e,i){if("function"==typeof this.onupdate)return this.onupdate(i,t,e)}),e,this.listtype)},this.titleFn("btntitle",e)||c)])];"string"==typeof this.description&&""!==this.description&&d.push(E("div",{class:"cbi-value-description"},this.description));var f=E("div",{class:"cbi-value",id:"cbi-%s-%s-%s".format(o,e,this.option),"data-index":t,"data-depends":u,"data-field":this.cbid(e),"data-name":this.option,"data-widget":this.__name__},[E("label",{class:"cbi-value-title",for:"widget.cbid.%s.%s.%s".format(o,e,this.option)},[c]),E("div",{class:"cbi-value-field"},d)]);return u&&u.length&&f.classList.add("hidden"),f.addEventListener("widget-change",L.bind(this.map.checkDepends,this.map)),L.dom.bindClassInstance(f,this),f}),this))},remove:function(){},write:function(){}}),CUSTOMRunningStatus=form.AbstractValue.extend({__name__:"CUSTOM.RunningStatus",fetchVersion:function(t){L.resolveDefault(callxrayVersion(),"").then((function(e){L.dom.content(t,e?_("Version: %s").format(e):E("em",{style:"color: red;"},_("Unable to get core version.")))}))},pollStatus:function(t){var e=E("em",{style:"color: red;"},_("Not Running")),i=E("em",{style:"color: green;"},_("Running"));L.Poll.add((function(){L.resolveDefault(callRunningStatus(),{code:0}).then((function(n){L.dom.content(t,n.code?e:i)}))}),5)},load:function(){},cfgvalue:function(){},render:function(){var t=E("span",{style:"margin-left: 5px"},E("em",{},_("Collecting data..."))),e=E("span",{},_("Getting..."));return this.pollStatus(t),this.fetchVersion(e),E("div",{class:"cbi-value"},[t," / ",e])},remove:function(){},write:function(){}});return L.Class.extend({TextValue:CUSTOMTextValue,ListStatusValue:CUSTOMListStatusValue,RunningStatus:CUSTOMRunningStatus,CallUuid:callGetUuid,CallGenKeys:callX25519,CallMldsa65:mldsa65Func});